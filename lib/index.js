"use strict";var support_1=require("./support"),styles_1=require("./styles"),conversions_1=require("./conversions"),util_1=require("./util"),colorSupport=new Proxy(support_1.getColorSupport(),{}),StyleCache=function(){function e(e,r){this.preserve=e||!1,this.value=r||""}return e.prototype.reset=function(){if(this.preserve)return this.value;var e=this.value;return this.value="",e},e}(),buildCrayon=function(e,r){function o(){}var s=new Proxy(o,crayonHandler);return o.colorSupport=colorSupport,o.$styleCache=new StyleCache(e,r),o.$functions={strip:function(e){return e.replace(/\x1b\[[0-9]([0-9])?([0-9])?m/gi,"")},keyword:function(e){e=styles_1.styles[e];return e&&(o.$styleCache.value+=e),s},hsl:function(e,r,t){var n;return(n=o.$functions).rgb.apply(n,conversions_1.hslToRgb(e,r,t))},bgHsl:function(e,r,t){var n;return(n=o.$functions).bgRgb.apply(n,conversions_1.hslToRgb(e,r,t))},rgb:function(e,r,t){return o.colorSupport.trueColor?(o.$styleCache.value+="[38;2;"+e+";"+r+";"+t+"m",s):o.colorSupport.highColor?o.$functions.ansi8(conversions_1.rgbToAnsi8(e,r,t)):o.$functions.ansi4(conversions_1.rgbToAnsi4(e,r,t))},bgRgb:function(e,r,t){return o.colorSupport.trueColor?(o.$styleCache.value+="[48;2;"+e+";"+r+";"+t+"m",s):o.colorSupport.highColor?o.$functions.bgAnsi8(conversions_1.rgbToAnsi8(e,r,t)):o.$functions.bgAnsi4(conversions_1.rgbToAnsi4(e,r,t))},hex:function(e,r){if(/#[0-F]{6}/.test(e)){var t=(e=e.slice(1)).match(/.{2}/g),n=parseInt(t[0],16),e=parseInt(t[1],16),t=parseInt(t[2],16);return r?o.$functions.ansi8(conversions_1.rgbToAnsi8(n,e,t)):o.$functions.rgb(n,e,t)}return util_1.crayonError("Incorrect usage of hex function"),s},bgHex:function(e,r){if(/#[0-F]{6}/.test(e)){var t=(e=e.slice(1)).match(/.{2}/g),n=parseInt(t[0],16),e=parseInt(t[1],16),t=parseInt(t[2],16);return r?o.$functions.bgAnsi8(conversions_1.rgbToAnsi8(n,e,t)):o.$functions.bgRgb(n,e,t)}return util_1.crayonError("Incorrect usage of bgHex function"),s},ansi8:function(e){return o.colorSupport.highColor?o.$styleCache.value+="[38;5;"+util_1.clamp(e,0,255)+"m":o.$functions.ansi4(conversions_1.ansi8ToAnsi4(e)),s},bgAnsi8:function(e){return o.colorSupport.highColor?o.$styleCache.value+="[48;5;"+util_1.clamp(e,0,255)+"m":o.$functions.bgAnsi4(conversions_1.ansi8ToAnsi4(e)),s},ansi4:function(e){return e=util_1.clamp(o.colorSupport.fourBitColor?e:e%8,0,15),o.$styleCache.value+="["+(e+(8<e?80:30))+"m",s},bgAnsi4:function(e){return e=util_1.clamp(o.colorSupport.fourBitColor?e:e%8,0,15),o.$styleCache.value+="["+(e+(8<e?90:40))+"m",s},ansi3:function(e){return o.$styleCache.value+="["+util_1.clamp(e+30,30,37)+"m",s},bgAnsi3:function(e){return o.$styleCache.value+="["+util_1.clamp(e+40,40,47)+"m",s}},s},literalStyleRegex=/{(\w+)((.|\s)*?)}/,compileLiteral=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t,n=e.join(""),o=n,s=o.match(literalStyleRegex),i="";return null!=s&&s.length&&(t=s[1],t=(i=i||styles_1.styles[t.trim()])+s[2]+styles_1.styles.reset,o=n.replace(s[0],t)),literalStyleRegex.test(o)?compileLiteral(i,o):o},crayonHandler={apply:function(e,r,t){if(!t.length)return buildCrayon();t=t[0];return literalStyleRegex.test(t)?compileLiteral(t):e.$styleCache.reset()+t+styles_1.styles.reset},get:function(e,r,t){t=Reflect.get(e,r,t)||Reflect.get(e.$functions,r,t);if(t)return t;r=Reflect.get(styles_1.styles,r);return r&&(e.$styleCache.value+=r),buildCrayon(e.$styleCache.preserve,e.$styleCache.reset())}},crayon=buildCrayon(!1);module.exports=crayon;